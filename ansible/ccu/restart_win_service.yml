---
- name: Restart one or more Windows services from survey input
  hosts: all
  gather_facts: false

  vars:
    restart_services_input: "{{ survey_services | default('', true) }}"
    restart_toggle: "{{ survey_restart_service | default(true) | bool }}"

  tasks:
    - name: Normalize survey input into newline-delimited text
      ansible.builtin.set_fact:
        _normalized_text: >-
          {{
            (
              restart_services_input if restart_services_input is string
              else (restart_services_input | flatten | map('string') | join('\n'))
            )
            | regex_replace('\r\n', '\n')
            | regex_replace('[,;]+', '\n')
          }}

    - name: Build flat service list
      ansible.builtin.set_fact:
        service_list: >-
          {{
            _normalized_text
            | split('\n')
            | map('trim')
            | reject('equalto','')
            | list
          }}

    - name: Show planned restarts
      ansible.builtin.debug:
        msg:
          - "Restart flag: {{ restart_toggle }}"
          - "Services to restart: {{ service_list | join(', ') if service_list|length > 0 else '(none)'}}"

    - name: Fail fast if restart requested but no services were provided
      ansible.builtin.fail:
        msg: "No service names were provided in the survey input."
      when:
        - restart_toggle
        - service_list | length == 0

    - name: Restart service - {{ item | string }}
      when:
        - restart_toggle
        - service_list | length > 0
      ansible.windows.win_service:
        name: "{{ item | string }}"
        state: restarted
        force_dependent_services: true
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Wait until service is up - {{ item | string }}
      when:
        - restart_toggle
        - service_list | length > 0
      ansible.windows.win_service_info:
        name: "{{ item | string }}"
      register: svcinfo_single
      until: >
        (svcinfo_single.services is defined)
        and (svcinfo_single.services | length > 0)
        and (
          (svcinfo_single.services[0].state | lower) in ['running', 'started']
          or (svcinfo_single.services[0].state | lower) == 'start_pending'
        )
      retries: 12
      delay: 5
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Gather final service states
      when: service_list | length > 0
      ansible.windows.win_service_info:
        name: "{{ item | string }}"
      register: final_states
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Print summary per service
      when: final_states is defined
      vars:
        svc: "{{ (item.services | default([])) | first | default({}) }}"
      ansible.builtin.debug:
        msg: "{{ svc.name | default(item.invocation.module_args.name) }}: {{ svc.state | default('unknown') }}"
      loop: "{{ final_states.results }}"
      loop_control:
        label: "{{ item.invocation.module_args.name }}"
