- name: List and email ongoing PagerDuty maintenance windows
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    pagerduty_token: "{{ lookup('env', 'PAGERDUTY_API_TOKEN') }}"
    smtp_port: 25

  tasks:
    - name: Fetch ongoing maintenance windows
      ansible.builtin.uri:
        url: "https://api.pagerduty.com/maintenance_windows?filter=open"
        method: GET
        headers:
          Authorization: "Token token={{ pagerduty_token }}"
          Accept: "application/vnd.pagerduty+json;version=2"
        return_content: true
        status_code: 200
      register: pd_response

    - name: Initialize empty list for parsed details
      ansible.builtin.set_fact:
        maintenance_details: []

    - name: Append parsed maintenance details (epoch Pacific)
      ansible.builtin.set_fact:
        maintenance_details: "{{ maintenance_details + [new_entry] }}"
      vars:
        start_epoch: >-
          {{
            (item.start_time is defined and item.start_time | length > 0)
              | ternary((item.start_time | to_datetime('%Y-%m-%dT%H:%M:%S%z')).timestamp() | int - 25200, 0)
          }}
        end_epoch: >-
          {{
            (item.end_time is defined and item.end_time | length > 0)
              | ternary((item.end_time | to_datetime('%Y-%m-%dT%H:%M:%S%z')).timestamp() | int - 25200, None)
          }}
        new_entry:
          id: "{{ item.id }}"
          description: "{{ item.description | default('') }}"
          services: "{{ item.services }}"
          start_epoch: "{{ start_epoch }}"
          end_epoch: "{{ end_epoch }}"
      loop: "{{ pd_response.json.maintenance_windows }}"
      loop_control:
        loop_var: item

    - name: Format start time
      ansible.builtin.command: "date -d @{{ item.start_epoch }} +'%b %d, %Y %I:%M %p %Z'"
      register: start_fmt
      loop: "{{ maintenance_details }}"
      loop_control:
        loop_var: item

    - name: Format end time
      ansible.builtin.command: >-
        {{ (item.end_epoch is not none) | ternary(
          "date -d @" ~ item.end_epoch|string ~ " +'%b %d, %Y %I:%M %p %Z'", "echo N/A") }}
      register: end_fmt
      loop: "{{ maintenance_details }}"
      loop_control:
        loop_var: item

    - name: Set has_maintenance flag
      ansible.builtin.set_fact:
        has_maintenance: "{{ pd_response.json.maintenance_windows | length > 0 }}"

    - name: Build email message body (no epoch)
      ansible.builtin.set_fact:
        maintenance_email_body: |
          {% for i in range(maintenance_details | length) %}
          ğŸ”— Services    : {{ maintenance_details[i].services | map(attribute='summary') | join(', ') }}
          ğŸ“„ Description : {{ maintenance_details[i].description | default('N/A') }}
          ğŸ•’ Start       : {{ start_fmt.results[i].stdout }}
          ğŸ•“ End         : {{ end_fmt.results[i].stdout }}
          ğŸ›  ID           : {{ maintenance_details[i].id }}

          {% endfor %}
      when: has_maintenance

    - name: Email maintenance windows report
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        to: "{{ email_recipient }}"
        from: "{{ email_sender }}"
        subject: "ğŸ“‹ Ongoing PagerDuty Maintenance Windows"
        body: "{{ maintenance_email_body }}"
      when: has_maintenance

    - name: No open maintenance windows
      ansible.builtin.debug:
        msg: "âœ… No open maintenance windows to report."
      when: not has_maintenance
