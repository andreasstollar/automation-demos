- name: Install PFX from SMB (already authenticated) + bind to IIS
  hosts: all
  gather_facts: no
  vars:
    site_name: "Default Web Site"
    pfx_src_unc: '\\ops-syn-01.ccu.loc\MediaShares\Information Technology\cert\2026\wildcard_columbiacu_org.pfx'  # youâ€™re already permitted to read this
    pfx_dest: 'C:\temp\wildcard_columbiacu_org.pfx'
    store_location: "LocalMachine"
    store_name: "My"
    pfx_password: "{{ pfx_password | mandatory }}"

  tasks:
    - name: Ensure temp dir exists
      ansible.windows.win_file:
        path: "{{ pfx_dest | regex_replace('\\\\[^\\\\]+$','') }}"
        state: directory

    - name: Copy PFX from UNC only if different
      ansible.windows.win_shell: |
        $src='{{ pfx_src_unc }}'
        $dst='{{ pfx_dest }}'
        $needCopy = $true
        if (Test-Path $dst) {
          try {
            $h1 = (Get-FileHash -Algorithm SHA256 -Path $src).Hash
            $h2 = (Get-FileHash -Algorithm SHA256 -Path $dst).Hash
            if ($h1 -eq $h2) { $needCopy = $false }
          } catch { }
        }
        if ($needCopy) { Copy-Item -Path $src -Destination $dst -Force; 'copied' } else { 'skipped' }
      register: smb_copy
      changed_when: "'copied' in (smb_copy.stdout | default(''))"

    - name: Read thumbprint from the PFX
      ansible.windows.win_shell: |
        $ErrorActionPreference = 'Stop'
        try {
          (Get-PfxCertificate -FilePath "{{ pfx_dest }}").Thumbprint
        } catch {
          $pwd = ConvertTo-SecureString "{{ pfx_password }}" -AsPlainText -Force
          (Get-PfxData -FilePath "{{ pfx_dest }}" -Password $pwd).EndEntityCertificates[0].Thumbprint
        }
      register: pfx_thumb_cmd

    - name: Set fact for PFX thumbprint
      ansible.builtin.set_fact:
        pfx_thumb: "{{ pfx_thumb_cmd.stdout | trim }}"

    - name: Check if cert already present in LocalMachine\My
      ansible.windows.win_shell: |
        if (Get-ChildItem Cert:\LocalMachine\My | Where-Object Thumbprint -eq "{{ pfx_thumb }}") { 'present' } else { 'absent' }
      register: cert_state

    - name: Import PFX into certificate store (only if missing)
      ansible.windows.win_certificate_store:
        path: "{{ pfx_dest }}"
        file_type: pkcs12
        password: "{{ pfx_password }}"
        key_storage: machine
        store_location: "{{ store_location }}"
        store_name: "{{ store_name }}"
        state: present
      when: cert_state.stdout != 'present'

    - name: Ensure HTTPS binding exists for the site with this cert
      community.windows.win_iis_webbinding:
        name: "{{ site_name }}"
        protocol: https
        port: 443
        ip: "*"
        hostname: ""                     # set host header if using SNI
        certificate_hash: "{{ pfx_thumb }}"
        certificate_store_name: "{{ store_name }}"
        state: present
      register: binding_result

    - name: Reload IIS configuration (graceful, only if binding changed)
      ansible.windows.win_shell: iisreset /noforce
      when: binding_result.changed

    - name: Remove PFX from disk (cleanup)
      ansible.windows.win_file:
        path: "{{ pfx_dest }}"
        state: absent
