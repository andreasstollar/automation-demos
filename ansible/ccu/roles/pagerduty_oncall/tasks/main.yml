- name: Initialize pagination variables
  set_fact:
    offset: 0
    all_oncalls: []
    more: true

- name: Loop and fetch paginated PagerDuty data
  include_tasks: fetch_page.yml
  loop: "{{ range(0, max_pages) | list }}"
  loop_control:
    loop_var: page
  when: more

- name: Filter for level 1 on-call entries
  include_tasks: filter_oncalls.yml

- name: Parse filtered oncall entries
  include_tasks: parse_oncalls.yml

- name: Format entries for HTML email
  include_tasks: format_oncalls.yml

- name: Send formatted email report
  include_tasks: send_email.yml
