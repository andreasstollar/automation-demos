- name: Ensure listed Windows services are running (Playbook B)
  hosts: all
  gather_facts: false

  vars:
    # Provided via Workflow Survey
    restart_services_input: "{{ survey_services | default('', true) }}"

  tasks:
    - name: Skip this host if not in restart targets
      ansible.builtin.meta: end_host
      when:
        - needs_restart_hosts is defined
        - needs_restart_hosts | length > 0
        - inventory_hostname not in needs_restart_hosts

    - name: Normalize survey input into newline-delimited text
      ansible.builtin.set_fact:
        _normalized_text: >-
          {{
            (
              restart_services_input if restart_services_input is string
              else (restart_services_input | flatten | join('\n'))
            )
            | regex_replace('\r\n', '\n')
            | regex_replace('[,;]+', '\n')
          }}

    - name: Build flat service list
      ansible.builtin.set_fact:
        service_list: >-
          {{
            _normalized_text
            | split('\n')
            | map('trim')
            | reject('equalto','')
            | list
          }}

    - name: Fail if no services provided
      ansible.builtin.fail:
        msg: "No service names were provided."
      when: service_list | length == 0

    - name: Ensure service is started (no bounce) - {{ item | string }}
      ansible.windows.win_service:
        name: "{{ item | string }}"
        state: started
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Verify service is up - {{ item | string }}
      ansible.windows.win_service_info:
        name: "{{ item | string }}"
      register: svcinfo_single
      until: >
        (svcinfo_single.services | default([]) | length) > 0 and
        (
          (svcinfo_single.services[0].state | lower) in ['running','started']
          or (svcinfo_single.services[0].state | lower) == 'start_pending'
        )
      retries: 12
      delay: 5
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Final report per service
      ansible.windows.win_service_info:
        name: "{{ item | string }}"
      register: final_states
      loop: "{{ service_list }}"
      loop_control:
        label: "{{ item | string }}"

    - name: Print summary
      vars:
        svc: "{{ (item.services | default([])) | first | default({}) }}"
      ansible.builtin.debug:
        msg: "{{ svc.name | default(item.invocation.module_args.name) }}: {{ svc.state | default('unknown') }}"
      loop: "{{ final_states.results }}"
      loop_control:
        label: "{{ item.invocation.module_args.name }}"
