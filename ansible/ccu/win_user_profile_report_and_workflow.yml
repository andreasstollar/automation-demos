# =============================================================================
# Play 1 — Collect per-host Windows profiles with orphan detection
# =============================================================================
- name: Windows user profile size, last login, and orphan detection (per host)
  hosts: all                      # <-- your Windows inventory group
  gather_facts: false

  vars:
    profile_root: 'C:\Users'
    csv_path: 'C:\Windows\Temp\user_profile_report.csv'
    enable_ad_checks: true
    enable_ad_enrichment: false

  tasks:
    - name: Collect profile data via PowerShell (orphan aware)
      ansible.windows.win_shell: |-
        $ErrorActionPreference = "Stop"

        function Convert-DmtfToDateString {
          param([object]$Value)
          if ($null -eq $Value) { return $null }
          if ($Value -is [datetime]) { return $Value.ToString('yyyy-MM-dd HH:mm:ss') }
          $s = [string]$Value
          if ([string]::IsNullOrWhiteSpace($s)) { return $null }
          if ($s -eq '00000000000000.000000+000') { return $null }
          if (-not ($s -match '^\d{14}\.\d{6}[\+\-]\d{3}$')) { return $null }
          try { return ([Management.ManagementDateTimeConverter]::ToDateTime($s)).ToString('yyyy-MM-dd HH:mm:ss') } catch { return $null }
        }

        $profiles = Get-CimInstance Win32_UserProfile |
          Where-Object { $_.LocalPath -like "{{ profile_root }}\*" -and -not $_.Special }

        $computer = $env:COMPUTERNAME
        $out = @()

        # Optional AD
        $hasAD = $false
        if ("{{ enable_ad_checks | default(true) }}".ToLower() -eq "true") {
          Import-Module ActiveDirectory -ErrorAction SilentlyContinue
          $hasAD = [bool](Get-Module ActiveDirectory -ListAvailable)
        }

        foreach ($p in $profiles) {
          $path = $p.LocalPath
          $sid  = $p.SID

          # Defaults
          $accountType = 'sid-only'
          $accountDomain = $null
          $accountName = $null
          $accountExists = 'unknown'
          $accountEnabled = $null
          $orphaned = $false
          $orphanReason = $null

          # SID -> DOMAIN\User
          $acct = $sid
          try {
            $acct = (New-Object System.Security.Principal.SecurityIdentifier($sid)).
              Translate([System.Security.Principal.NTAccount]).Value
          } catch { }

          if ($acct -ne $sid -and $acct -match "^(?<dom>[^\\]+)\\(?<usr>.+)$") {
            $accountDomain = $Matches['dom']
            $accountName = $Matches['usr']
            if ($accountDomain -eq $computer) {
              $accountType = 'local'
              try {
                $llu = Get-LocalUser -Name $accountName -ErrorAction Stop
                if ($llu) {
                  $accountExists = 'true'
                  $accountEnabled = [bool]$llu.Enabled
                }
              } catch {
                $accountExists = 'false'
                $orphaned = $true
                $orphanReason = 'Local user not found'
              }
            } else {
              $accountType = 'domain'
              if ($hasAD) {
                try {
                  $ad = Get-ADUser -Identity $accountName -Server $accountDomain -Properties Enabled -ErrorAction Stop
                  if ($ad) {
                    $accountExists = 'true'
                    $accountEnabled = [bool]$ad.Enabled
                  }
                } catch {
                  $accountExists = 'false'
                  $orphaned = $true
                  $orphanReason = 'AD user not found'
                }
              } else {
                $accountExists = 'unknown'
              }
            }
          } else {
            $orphaned = $true
            $orphanReason = 'SID does not resolve'
          }

          # Compute folder size in BYTES (files only)
          try {
            $bytes = (Get-ChildItem -LiteralPath $path -Force -Recurse -ErrorAction SilentlyContinue |
                      Where-Object { -not $_.PSIsContainer } |
                      Measure-Object -Sum Length).Sum
          } catch { $bytes = $null }

          $lut = Convert-DmtfToDateString -Value $p.LastUseTime

          # Prefer local LastLogon when local user
          $lastLogin = $null
          if ($accountType -eq 'local' -and $accountExists -eq 'true') {
            try {
              $llu = Get-LocalUser -Name $accountName -ErrorAction Stop
              if ($llu -and $llu.LastLogon) { $lastLogin = $llu.LastLogon.ToString('yyyy-MM-dd HH:mm:ss') }
            } catch { }
          }
          if (-not $lastLogin) { $lastLogin = $lut }
          if (-not $lastLogin) { $lastLogin = "Never" }

          $sizeMB = if ($bytes) { [Math]::Round($bytes/1MB, 2) } else { $null }
          $sizeGB = if ($bytes) { [Math]::Round($bytes/1GB, 2) } else { $null }

          $out += [pscustomobject]@{
            username        = ($acct)
            sid             = $sid
            account_domain  = $accountDomain
            account_name    = $accountName
            account_type    = $accountType
            account_exists  = $accountExists
            account_enabled = $accountEnabled
            orphaned        = $orphaned
            orphan_reason   = $orphanReason
            profilePath     = $path
            size_bytes      = $bytes
            size_mb         = $sizeMB
            size_gb         = $sizeGB
            last_login      = $lastLogin
            loaded          = $p.Loaded
          }
        }

        $out | ConvertTo-Json -Depth 4
      register: win_profile_raw
      changed_when: false

    - name: Parse JSON and sort by username (only if JSON present)
      ansible.builtin.set_fact:
        win_profile_report: "{{ (win_profile_raw.stdout | from_json) | sort(attribute='username') }}"
      when:
        - win_profile_raw is defined
        - (win_profile_raw.stdout | default('') | trim) | length > 0
        - (win_profile_raw.stdout | default('') | trim) is match('^[\\[{]')

    - name: Ensure report exists (fallback)
      ansible.builtin.set_fact:
        win_profile_report: "{{ win_profile_report | default([]) }}"

    - name: Try to enrich last_login from AD LastLogonDate (best effort)
      ansible.windows.win_shell: |
        $ErrorActionPreference = "SilentlyContinue"
        Import-Module ActiveDirectory -ErrorAction SilentlyContinue
        $hasAD = Get-Module ActiveDirectory -ListAvailable
        if (-not $hasAD -or ("{{ enable_ad_enrichment }}".ToLower() -ne "true")) { return }

        $rows = @()
        $report = {{ win_profile_report | to_json }}
        foreach ($r in $report) {
          if ($r.account_type -eq 'domain' -and $r.account_exists -eq 'true' -and $r.account_name) {
            try {
              $ad = Get-ADUser -Identity $r.account_name -Server $r.account_domain -Properties LastLogonDate
              if ($ad -and $ad.LastLogonDate) {
                $r.last_login = $ad.LastLogonDate.ToString('yyyy-MM-dd HH:mm:ss')
              }
            } catch {}
          }
          $rows += $r
        }
        $rows | ConvertTo-Json -Depth 4
      register: ad_enrich
      changed_when: false
      failed_when: false
      when: enable_ad_enrichment | bool

    - name: Use AD-enriched results if JSON is present
      ansible.builtin.set_fact:
        win_profile_report: "{{ ad_enrich.stdout | trim | from_json }}"
      when:
        - enable_ad_enrichment | bool
        - ad_enrich is defined
        - (ad_enrich.stdout | default('') | trim) | length > 0
        - (ad_enrich.stdout | default('') | trim) is match('^[\\[{]')
      changed_when: false

    - name: (Per-host) Write CSV to {{ csv_path }}
      ansible.windows.win_copy:
        dest: "{{ csv_path }}"
        content: |
          username,sid,account_domain,account_name,account_type,account_exists,account_enabled,orphaned,orphan_reason,profilePath,size_bytes,size_mb,size_gb,last_login,loaded
          {% for row in win_profile_report -%}
          {{ row.username }},{{ row.sid }},{{ row.account_domain | default('') }},{{ row.account_name | default('') }},{{ row.account_type }},{{ row.account_exists }},{{ row.account_enabled | default('') }},{{ row.orphaned }},{{ row.orphan_reason | default('') }},"{{ row.profilePath }}",{{ row.size_bytes | default('') }},{{ row.size_mb | default('') }},{{ row.size_gb | default('') }},"{{ row.last_login | replace('"','""') }}",{{ row.loaded }}
          {% endfor %}

# =============================================================================
# Play 2 — Aggregate on the controller, email report, and save list for builder
# =============================================================================
- name: Aggregate, compute cleanup GB, and email (controller)
  hosts: localhost                     # any matching group; runs locally below
  gather_facts: false

  vars:
    # Email settings
    mail_enabled: true
    mail_to: "ops@example.com"
    mail_from: "ansible@yourdomain.com"
    mail_subject: "Windows User Profiles – Orphaned Accounts & Cleanup Size"
    smtp_host: "smtp.yourdomain.com"
    smtp_port: 25
    attach_csv: true
    include_html_tables: true
    mail_debug: true

    # hosts that produced win_profile_report in Play 1
    hosts_to_aggregate: >-
      {{ hostvars | dict2items
         | selectattr('value.win_profile_report','defined')
         | map(attribute='key') | list }}

  tasks:
    - name: Aggregate & email from controller
      connection: local
      run_once: true
      block:
        - name: Set output paths under /tmp (or AWX_ISOLATED_DATA_DIR)
          ansible.builtin.set_fact:
            agg_dir: "{{ lookup('env','AWX_ISOLATED_DATA_DIR') | default('/tmp') }}"
            agg_csv_path: "{{ (lookup('env','AWX_ISOLATED_DATA_DIR') | default('/tmp')) ~ '/win_user_profiles_ALL.csv' }}"
            orphan_list_json: "{{ (lookup('env','AWX_ISOLATED_DATA_DIR') | default('/tmp')) ~ '/orphan_hosts.json' }}"
            email_preview_html: "{{ (lookup('env','AWX_ISOLATED_DATA_DIR') | default('/tmp')) ~ '/win_profiles_email_preview.html' }}"

        - name: Ensure aggregate dir exists
          ansible.builtin.file:
            path: "{{ agg_dir }}"
            state: directory
            mode: '0755'

        - name: Sanity — which hosts will be aggregated
          ansible.builtin.debug:
            msg: "Aggregating hosts: {{ hosts_to_aggregate }}"

        - name: Build per-host rows
          ansible.builtin.set_fact:
            _rows_for_host: "{{ (hostvars[h].win_profile_report | default([])) | map('combine', {'host': h}) | list }}"
          loop: "{{ hosts_to_aggregate }}"
          loop_control: { loop_var: h }
          register: _rows_per_host

        - name: Flatten rows
          ansible.builtin.set_fact:
            all_rows: "{{ (_rows_per_host.results | default([])) | map(attribute='ansible_facts._rows_for_host') | list | flatten | default([]) }}"

        - name: Sort rows by host then username
          ansible.builtin.set_fact:
            all_rows: "{{ (all_rows | sort(attribute='username')) | sort(attribute='host') }}"

        - name: Derive orphaned rows only
          ansible.builtin.set_fact:
            orphaned_rows: "{{ all_rows | selectattr('orphaned','equalto', true) | list | default([]) }}"

        - name: Sum potential cleanup bytes (orphaned only)
          ansible.builtin.set_fact:
            total_cleanup_bytes: "{{ (total_cleanup_bytes | default(0) | int) + (item.size_bytes | default(0) | int) }}"
          loop: "{{ orphaned_rows }}"

        - name: Convert total cleanup to GB (rounded)
          ansible.builtin.set_fact:
            total_cleanup_gb: "{{ ((total_cleanup_bytes | default(0) | float) / 1073741824) | round(2) }}"

        - name: Build per-host cleanup bytes dict
          ansible.builtin.set_fact:
            cleanup_bytes_by_host: >-
              {{
                (cleanup_bytes_by_host | default({})) |
                combine({
                  item.host: (
                    (cleanup_bytes_by_host[item.host] | default(0) | int)
                    + (item.size_bytes | default(0) | int)
                  )
                })
              }}
          loop: "{{ orphaned_rows }}"

        - name: Convert per-host cleanup to list with GB
          ansible.builtin.set_fact:
            cleanup_by_host_list: "{{ (cleanup_by_host_list | default([])) + [ {
                'host': item.key,
                'bytes': (item.value | default(0) | int),
                'gb': (((item.value | default(0) | float) / 1073741824) | round(2))
              } ] }}"
          loop: "{{ (cleanup_bytes_by_host | default({})) | dict2items }}"

        - name: Write aggregated CSV (all rows)
          ansible.builtin.copy:
            dest: "{{ agg_csv_path }}"
            mode: '0644'
            content: |-
              host,username,sid,account_domain,account_name,account_type,account_exists,account_enabled,orphaned,orphan_reason,profilePath,size_bytes,size_mb,size_gb,last_login,loaded
              {% for row in all_rows -%}
              {{ row.host }},{{ row.username }},{{ row.sid }},{{ row.account_domain | default('') }},{{ row.account_name | default('') }},{{ row.account_type }},{{ row.account_exists }},{{ row.account_enabled | default('') }},{{ row.orphaned }},{{ row.orphan_reason | default('') }},"{{ row.profilePath }}",{{ row.size_bytes | default('') }},{{ row.size_mb | default('') }},{{ row.size_gb | default('') }},"{{ row.last_login | default('') | replace('"','""') }}",{{ row.loaded | default('') }}
              {% endfor %}

        - name: Build HTML email body (summary + orphaned table)
          when: include_html_tables | bool
          ansible.builtin.set_fact:
            email_html: |-
              <!doctype html><html><head><meta charset="utf-8">
              <style>body{font-family:Arial,Helvetica,sans-serif;font-size:14px}
              table{border-collapse:collapse;width:100%;margin-top:10px}
              th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}
              th{background:#f2f2f2}.meta{margin-bottom:12px}.small{color:#555;font-size:12px}
              .pill{display:inline-block;padding:2px 8px;border-radius:12px;background:#eef}</style>
              </head><body>
              <div class="meta">
                <div><strong>Windows User Profiles – Orphaned Accounts & Cleanup</strong></div>
                <div class="small">Hosts: {{ hosts_to_aggregate | join(', ') }}</div>
                <div class="small">Generated at: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }} (UTC)</div>
              </div>
              <div><strong>Total potential cleanup:</strong> <span class="pill">{{ total_cleanup_gb | default(0) }} GB</span></div>
              <table><thead><tr><th>Host</th><th>Potential cleanup (GB)</th></tr></thead><tbody>
              {% for r in (cleanup_by_host_list | default([])) %}<tr><td>{{ r.host | e }}</td><td>{{ r.gb }}</td></tr>{% endfor %}
              {% if (cleanup_by_host_list | default([])) | length == 0 %}<tr><td colspan="2">No orphaned profiles detected.</td></tr>{% endif %}
              </tbody></table>
              <table><thead><tr><th>Host</th><th>Username</th><th>SID</th><th>Profile Path</th><th>Size (GB)</th><th>Last Login</th><th>Reason</th></tr></thead><tbody>
              {% for r in (orphaned_rows | default([])) %}<tr>
                <td>{{ r.host | e }}</td><td>{{ r.username | default('') | e }}</td><td>{{ r.sid | default('') | e }}</td>
                <td>{{ r.profilePath | default('') | e }}</td><td>{{ ((r.size_bytes | default(0) | float) / 1073741824) | round(2) }}</td>
                <td>{{ r.last_login | default('') | e }}</td><td>{{ r.orphan_reason | default('') | e }}</td>
              </tr>{% endfor %}
              {% if (orphaned_rows | default([])) | length == 0 %}<tr><td colspan="7">No orphaned profiles detected.</td></tr>{% endif %}
              </tbody></table></body></html>

        - name: Wait for SMTP connectivity
          ansible.builtin.wait_for:
            host: "{{ smtp_host }}"
            port: "{{ smtp_port }}"
            timeout: 8
            state: started

        - name: Email the report (HTML body; CSV optional)
          community.general.mail:
            host: "{{ smtp_host }}"
            port: "{{ smtp_port }}"
            to: "{{ mail_to }}"
            from: "{{ mail_from }}"
            subject: "{{ mail_subject }}"
            subtype: "html"
            body: "{{ email_html }}"
            attach: "{{ (attach_csv | bool) | ternary([agg_csv_path], omit) }}"
          register: mail_result
          no_log: "{{ not mail_debug }}"
          when: (mail_enabled | bool)

        - name: Save HTML email preview
          ansible.builtin.copy:
            dest: "{{ email_preview_html }}"
            mode: '0644'
            content: "{{ email_html }}"
          when: include_html_tables | bool

        - name: Save orphan host list for workflow builder
          ansible.builtin.copy:
            dest: "{{ orphan_list_json }}"
            mode: '0644'
            content: "{{ (cleanup_by_host_list | default([]) | selectattr('bytes','gt',0) | list) | to_nice_json }}"

        - name: Expose artifact paths/metrics to Tower
          ansible.builtin.set_stats:
            data:
              aggregated_user_profile_csv: "{{ agg_csv_path }}"
              orphaned_total_cleanup_gb: "{{ total_cleanup_gb | default(0) }}"
              orphan_hosts: "{{ cleanup_by_host_list | default([]) | selectattr('bytes','gt',0) | map(attribute='host') | list }}"

# =============================================================================
# Play 3 — Auto-build per-host approval workflow in Tower using awx.awx
# =============================================================================
- name: Build/refresh Workflow with per-host approvals (from report)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - awx.awx

  vars:
    # Same path logic as Play 2
    orphan_list_json: "{{ (lookup('env','AWX_ISOLATED_DATA_DIR') | default('/tmp')) ~ '/orphan_hosts.json' }}"

    # Edit to match your Tower names
    workflow_name:    "Windows Profile Cleanup (Per-Host Approvals)"
    cleanup_template: "Win Profile Cleanup (per-host)"   # JT running win_profile_cleanup.yml
    report_template:  "Win Profile Report"               # optional anchor node

    # Auth (omit if a Controller credential is attached or env vars are set)
    tower_host: "{{ lookup('env','TOWER_HOST') | default(omit) }}"
    tower_oauthtoken: "{{ lookup('env','TOWER_OAUTH_TOKEN') | default(omit) }}"
    tower_username: "{{ lookup('env','TOWER_USERNAME') | default(omit) }}"
    tower_password: "{{ lookup('env','TOWER_PASSWORD') | default(omit) }}"
    validate_certs: true

  tasks:
    - name: Read orphan host list
      ansible.builtin.slurp:
        src: "{{ orphan_list_json }}"
      register: orphan_file
      failed_when: orphan_file is failed or (orphan_file.content | length) == 0

    - name: Parse hosts to approve
      ansible.builtin.set_fact:
        orphan_items: "{{ orphan_file.content | b64decode | from_json }}"   # [{host,bytes,gb}]
        hosts_for_approval: "{{ orphan_items | map(attribute='host') | list }}"

    # Recreate workflow to avoid stale nodes
    - name: Remove existing workflow (if present)
      awx.awx.workflow_job_template:
        name: "{{ workflow_name }}"
        state: absent
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"

    - name: Create workflow
      awx.awx.workflow_job_template:
        name: "{{ workflow_name }}"
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"

    - name: Create report node (optional anchor)
      awx.awx.workflow_job_template_node:
        workflow_job_template: "{{ workflow_name }}"
        identifier: "report"
        unified_job_template: "{{ report_template }}"
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"

    - name: Approval node for each host
      awx.awx.workflow_job_template_node:
        workflow_job_template: "{{ workflow_name }}"
        identifier: "{{ 'approve_' ~ (host | regex_replace('[^A-Za-z0-9_-]', '_')) }}"
        approval_node: true
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
      loop: "{{ hosts_for_approval }}"
      loop_control: { loop_var: host, label: "{{ host }}" }

    - name: Cleanup node for each host
      awx.awx.workflow_job_template_node:
        workflow_job_template: "{{ workflow_name }}"
        identifier: "{{ 'cleanup_' ~ (host | regex_replace('[^A-Za-z0-9_-]', '_')) }}"
        unified_job_template: "{{ cleanup_template }}"
        limit: "{{ host }}"
        extra_data:
          approve_cleanup: true
          what_if: false
          only_orphaned: true
          min_inactive_days: 90
          min_size_gb: 1
          enable_ad_checks: true
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
      loop: "{{ hosts_for_approval }}"
      loop_control: { loop_var: host, label: "{{ host }}" }

    - name: Wire report → approval for each host
      awx.awx.workflow_job_template_node:
        workflow_job_template: "{{ workflow_name }}"
        identifier: "report"
        success_nodes:
          - "{{ 'approve_' ~ (host | regex_replace('[^A-Za-z0-9_-]', '_')) }}"
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
      loop: "{{ hosts_for_approval }}"
      loop_control: { loop_var: host, label: "{{ host }}" }

    - name: Wire approval → cleanup for each host
      awx.awx.workflow_job_template_node:
        workflow_job_template: "{{ workflow_name }}"
        identifier: "{{ 'approve_' ~ (host | regex_replace('[^A-Za-z0-9_-]', '_')) }}"
        success_nodes:
          - "{{ 'cleanup_' ~ (host | regex_replace('[^A-Za-z0-9_-]', '_')) }}"
        state: present
        tower_host: "{{ tower_host | default(omit) }}"
        tower_oauthtoken: "{{ tower_oauthtoken | default(omit) }}"
        tower_username: "{{ tower_username | default(omit) }}"
        tower_password: "{{ tower_password | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
      loop: "{{ hosts_for_approval }}"
      loop_control: { loop_var: host, label: "{{ host }}" }
