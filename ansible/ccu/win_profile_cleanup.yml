- name: Cleanup orphaned/old Windows user profiles (safe + approval)
  hosts: windows
  gather_facts: false

  vars:
    approve_cleanup: false   # MUST be true to run
    what_if: true            # dry-run by default
    only_orphaned: true
    min_inactive_days: 90
    min_size_gb: 1
    enable_ad_checks: true
    delete_local_accounts: false
    allow_usernames: []      # optional allowlist; empty = all matching rules
    profile_root: 'C:\Users'

  pre_tasks:
    - name: Hard stop if not explicitly approved
      ansible.builtin.fail:
        msg: "Cleanup blocked: set approve_cleanup=true to proceed."
      when: not approve_cleanup | bool

  tasks:
    - name: Collect profiles + orphan status (re-detect live)
      ansible.windows.win_shell: |-
        $ErrorActionPreference = "Stop"

        function Convert-DmtfToDateTime {
          param([object]$Value)
          if ($null -eq $Value) { return $null }
          if ($Value -is [datetime]) { return $Value }
          $s = [string]$Value
          if ([string]::IsNullOrWhiteSpace($s)) { return $null }
          if ($s -eq '00000000000000.000000+000') { return $null }
          if (-not ($s -match '^\d{14}\.\d{6}[\+\-]\d{3}$')) { return $null }
          try { return [Management.ManagementDateTimeConverter]::ToDateTime($s) } catch { return $null }
        }

        $profiles = Get-CimInstance Win32_UserProfile |
          Where-Object { $_.LocalPath -like "{{ profile_root }}\*" -and -not $_.Special }

        $computer = $env:COMPUTERNAME
        $out = @()

        $hasAD = $false
        if ("{{ enable_ad_checks }}".ToLower() -eq "true") {
          Import-Module ActiveDirectory -ErrorAction SilentlyContinue
          $hasAD = [bool](Get-Module ActiveDirectory -ListAvailable)
        }

        foreach ($p in $profiles) {
          $sid  = $p.SID
          $path = $p.LocalPath

          $acct = $sid
          try { $acct = (New-Object System.Security.Principal.SecurityIdentifier($sid)).Translate([System.Security.Principal.NTAccount]).Value } catch {}

          $accountType   = 'sid-only'
          $accountDomain = $null
          $accountName   = $null
          $accountExists = 'unknown'
          $orphaned      = $false
          $orphanReason  = $null

          if ($acct -ne $sid -and $acct -match "^(?<dom>[^\\]+)\\(?<usr>.+)$") {
            $accountDomain = $Matches['dom']; $accountName = $Matches['usr']
            if ($accountDomain -eq $computer) {
              $accountType = 'local'
              try { $llu = Get-LocalUser -Name $accountName -ErrorAction Stop; if ($llu) { $accountExists = 'true' } }
              catch { $accountExists = 'false'; $orphaned = $true; $orphanReason = 'Local user not found' }
            } else {
              $accountType = 'domain'
              if ($hasAD) {
                try { $ad = Get-ADUser -Identity $accountName -Server $accountDomain -ErrorAction Stop; if ($ad) { $accountExists = 'true' } }
                catch { $accountExists = 'false'; $orphaned = $true; $orphanReason = 'AD user not found' }
              }
            }
          } else { $orphaned = $true; $orphanReason = 'SID does not resolve' }

          try {
            $bytes = (Get-ChildItem -LiteralPath $path -Force -Recurse -ErrorAction SilentlyContinue |
                      Where-Object { -not $_.PSIsContainer } | Measure-Object -Sum Length).Sum
          } catch { $bytes = $null }

          $lastUse = Convert-DmtfToDateTime -Value $p.LastUseTime
          if (-not $lastUse -and $accountType -eq 'local' -and $accountExists -eq 'true') {
            try { $llu = Get-LocalUser -Name $accountName -ErrorAction Stop; if ($llu -and $llu.LastLogon) { $lastUse = $llu.LastLogon } } catch {}
          }

          $out += [pscustomobject]@{
            username     = $acct
            sid          = $sid
            account_type = $accountType
            account_exists = $accountExists
            orphaned     = $orphaned
            orphan_reason= $orphanReason
            profilePath  = $path
            size_bytes   = $bytes
            last_used    = $lastUse
            loaded       = $p.Loaded
          }
        }

        $out | ConvertTo-Json -Depth 4
      register: win_profiles
      changed_when: false

    - name: Parse results
      ansible.builtin.set_fact:
        profiles: "{{ (win_profiles.stdout | default('') | trim) and (win_profiles.stdout | trim | from_json) or [] }}"

    - name: Build candidate deletion list using rules
      ansible.builtin.set_fact:
        deletion_candidates: >-
          {{
            profiles
            | selectattr('loaded','equalto', false)
            | selectattr('size_bytes','defined') | selectattr('size_bytes','ne', None)
            | selectattr('size_bytes','ge', (min_size_gb | float) * 1073741824 )
            | list
          }}

    - name: If only_orphaned, filter to orphaned
      ansible.builtin.set_fact:
        deletion_candidates: "{{ deletion_candidates | selectattr('orphaned','equalto', true) | list }}"
      when: only_orphaned | bool

    - name: Apply inactivity filter (min_inactive_days)
      ansible.builtin.set_fact:
        deletion_candidates: >-
          {{
            deletion_candidates
            | selectattr('last_used','defined') | selectattr('last_used','ne', None)
            | selectattr('last_used','lt',
                (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ')) - (min_inactive_days | int) * 86400 )
            | list
          }}

    - name: Show planned deletions (dry-run view)
      ansible.builtin.debug:
        msg: "{{ deletion_candidates | map(attribute='username') | list }}"
      when: deletion_candidates | length > 0

    - name: Compute total reclaimable bytes (planned)
      ansible.builtin.set_fact:
        planned_reclaim_bytes: "{{ (deletion_candidates | map(attribute='size_bytes') | list | sum) | default(0) }}"

    - name: Delete profiles (what-if or real)
      ansible.windows.win_shell: |-
        $whatIf = [bool]{{ what_if | bool }}
        $targets = {{ deletion_candidates | to_json }}
        $results = @()
        foreach ($t in $targets) {
          $path = $t.profilePath; $sid  = $t.sid
          try {
            $prof = Get-CimInstance Win32_UserProfile -Filter ("SID='{0}'" -f $sid)
            if ($null -ne $prof -and -not $prof.Loaded) {
              if ($whatIf) {
                $results += [pscustomobject]@{ username=$t.username; sid=$sid; path=$path; action="WouldRemove"; bytes=$t.size_bytes }
              } else {
                Remove-CimInstance -InputObject $prof -ErrorAction Stop
                $results += [pscustomobject]@{ username=$t.username; sid=$sid; path=$path; action="Removed"; bytes=$t.size_bytes }
              }
            } else {
              $results += [pscustomobject]@{ username=$t.username; sid=$sid; path=$path; action="SkippedLoadedOrMissing"; bytes=$t.size_bytes }
            }
          } catch {
            $results += [pscustomobject]@{ username=$t.username; sid=$sid; path=$path; action=("Error:" + $_.Exception.Message); bytes=$t.size_bytes }
          }
        }
        $results | ConvertTo-Json -Depth 4
      register: delete_results
      changed_when: false
      when: deletion_candidates | length > 0

    - name: Summarize results per host
      ansible.builtin.set_fact:
        cleanup_summary:
          host: "{{ inventory_hostname }}"
          what_if: "{{ what_if | bool }}"
          planned_count: "{{ deletion_candidates | length }}"
          planned_gb: "{{ ((planned_reclaim_bytes | float) / 1073741824) | round(2) }}"
          actions: "{{ (delete_results.stdout | default('') | trim) and (delete_results.stdout | trim | from_json) or [] }}"
