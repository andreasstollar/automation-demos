---
- name: Use existing PagerDuty escalation policy PPP17EM, create service & Datadog monitor
  hosts: branch_nas
  gather_facts: false

  vars:
    datadog_api_host: "https://api.us3.datadoghq.com"

  tasks:

    - name: Ensure datadog Python library is installed
      ansible.builtin.pip:
        name: datadog
      delegate_to: localhost
      run_once: true

    - name: Configure Datadog API auth
      ansible.builtin.set_fact:
        datadog_auth:
          api_key: "{{ datadog_api_key }}"
          app_key: "{{ datadog_app_key }}"
      delegate_to: localhost

    - name: Fail if branch not defined
      ansible.builtin.fail:
        msg: "Host {{ inventory_hostname }} is missing required variable: branch"
      when: branch is not defined
      delegate_to: localhost

    - name: Check if PagerDuty service already exists
      ansible.builtin.uri:
        url: "https://api.pagerduty.com/services?query={{ branch | default('unknown') }}%20NAS%20Monitoring"
        method: GET
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
        return_content: true
      register: pd_service_check
      delegate_to: localhost

    - name: Create PagerDuty service if not exists
      ansible.builtin.uri:
        url: "https://api.pagerduty.com/services"
        method: POST
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
          Content-Type: "application/json"
        body: |
          {
            "service": {
              "type": "service",
              "name": "{{ branch | default('unknown') }} NAS Monitoring",
              "description": "Service for NAS monitoring at {{ branch | default('unknown') }}",
              "escalation_policy": {
                "id": "PPP17EM",
                "type": "escalation_policy_reference"
              }
            }
          }
        status_code: 201
      when: pd_service_check.json.services | selectattr('name', 'equalto', branch ~ ' NAS Monitoring') | list | length == 0
      delegate_to: localhost

    - name: Create Datadog SNMP monitor
      community.general.datadog_monitor:
        api_key: "{{ datadog_auth.api_key }}"
        app_key: "{{ datadog_auth.app_key }}"
        api_host: "{{ datadog_api_host }}"
        state: present
        type: metric alert
        name: "{{ branch | default('unknown') }} {{ inventory_hostname }} NAS SNMP device down monitor"
        notification_message: |
          Branch NAS {{ inventory_hostname }} ({{ ansible_host }}) at branch {{ branch | default('unknown') }}
          is reporting only 2 or fewer OK responses. Please investigate. @network-team
        query: >
          count_last_3("snmp.can_check{snmp_host:{{ inventory_hostname }}} by {device_namespace,snmp_device}").by_status()
        thresholds:
          critical: 2
        tags:
          - snmp
          - network
          - branch_nas
          - device:{{ inventory_hostname }}
          - branch:{{ branch | default('unknown') }}
        services:
          - "{{ branch | default('unknown') }} NAS Monitoring"
        notify_no_data: true
        no_data_timeframe: 10
        require_full_window: true
        evaluation_delay: 120
      delegate_to: localhost
