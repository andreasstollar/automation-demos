- name: Ensure PagerDuty service, integration & SNMP monitor are in place
  hosts: branch_ups
  gather_facts: false

  vars:
    datadog_api_host: "https://api.us3.datadoghq.com"
    pagerduty_api_url: "https://api.pagerduty.com"
    pagerduty_service_name: "{{ branch }} UPS Monitoring"
    pagerduty_escalation_policy: "PPP17EM"
    pagerduty_integration_name: "Datadog"
    pagerduty_team_id: "P196ON5"

  tasks:
    - name: Install Datadog Python library on control node
      ansible.builtin.pip:
        name: datadog
      delegate_to: localhost
      run_once: true

    - name: Fail if branch variable is not defined
      ansible.builtin.fail:
        msg: "Branch variable is required!"
      when: branch is not defined
      delegate_to: localhost

    - name: Lookup existing PagerDuty service
      ansible.builtin.uri:
        url: "{{ pagerduty_api_url }}/services?query={{ pagerduty_service_name | urlencode }}"
        method: GET
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
        return_content: true
      register: pd_service_list
      failed_when: false
      delegate_to: localhost

    - name: Create PagerDuty service if missing
      ansible.builtin.uri:
        url: "{{ pagerduty_api_url }}/services"
        method: POST
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
          Content-Type:  "application/json"
        body_format: json
        body:
          service:
            type: service
            name: "{{ pagerduty_service_name }}"
            description: "UPS monitoring for {{ branch }}"
            escalation_policy:
              id: "{{ pagerduty_escalation_policy }}"
              type: escalation_policy_reference
        status_code: 201
      when: >
        pd_service_list.json.services is defined and
        (pd_service_list.json.services
         | selectattr('name','equalto', pagerduty_service_name)
         | list
         | length) == 0
      register: pd_service_create
      delegate_to: localhost

    - name: Determine PagerDuty service ID
      ansible.builtin.set_fact:
        pd_service_id: >-
          {{
            (
              pd_service_list.json.services
              | selectattr('name','equalto', pagerduty_service_name)
              | map(attribute='id')
              | list
            )
            | first
            | default(
                pd_service_create.json.service.id | default('')
              )
          }}
      delegate_to: localhost

    - name: Configure support-hours, dynamic urgency & assign Engineering team
      ansible.builtin.uri:
        url: "{{ pagerduty_api_url }}/services/{{ pd_service_id }}"
        method: PUT
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
          Content-Type:  "application/json"
        body_format: json
        body:
          service:
            scheduled_actions: []        # required by API even if empty
            support_hours:
              type: fixed_time_per_day
              time_zone: America/Los_Angeles
              days_of_week:
                - 1  #monday
                - 2  #tuesday
                - 3  #wednesday
                - 4  #thursday
                - 5  #friday
                - 6  #saturday
              start_time: "07:00"
              end_time:   "18:30"
            incident_urgency_rule:
              type: use_support_hours
              during_support_hours:
                type:    constant
                urgency: severity_based
              outside_support_hours:
                type:    constant
                urgency: low
            teams:
              - id:   "{{ pagerduty_team_id }}"
                type: team_reference
        status_code: 200
      delegate_to: localhost

    - name: Fetch existing integrations for PagerDuty service
      ansible.builtin.uri:
        url: "{{ pagerduty_api_url }}/services/{{ pd_service_id }}/integrations"
        method: GET
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
        return_content: true
      register: pd_integrations
      failed_when: false
      delegate_to: localhost

    - name: Create Datadog integration in PagerDuty if missing
      ansible.builtin.uri:
        url: "{{ pagerduty_api_url }}/services/{{ pd_service_id }}/integrations"
        method: POST
        headers:
          Authorization: "Token token={{ pagerduty_api_key }}"
          Accept: "application/vnd.pagerduty+json;version=2"
          Content-Type: "application/json"
        body_format: json
        body:
          integration:
            type: "datadog_reference"
            name: "{{ pagerduty_integration_name }}"
        status_code: 201
      when: >
        pd_integrations.json.integrations is defined and
        (pd_integrations.json.integrations
         | selectattr('name','equalto', pagerduty_integration_name)
         | list
         | length) == 0
      delegate_to: localhost

    - name: Create/Update SNMP submitted-metrics zero-sum alert in Datadog
      community.general.datadog_monitor:
        api_host: "{{ datadog_api_host }}"
        api_key: "{{ datadog_api_key }}"
        app_key: "{{ datadog_app_key }}"
        state: present
        type: metric alert
        name: "{{ branch }} UPS {{ inventory_hostname }} metrics monitor"

        # fire whenever any time-on-battery > 0
        query: "avg(last_5m):avg:snmp.upsBasicBatteryTimeOnBattery{device_ip:{{ inventory_hostname }}} by {device_namespace,snmp_device} > 600"

        notification_message: |
          {{ '{{#is_alert}}' }}
          ðŸš¨ UPS on battery at {{ inventory_hostname }} (branch {{ branch }}). Please investigate.
          @pagerduty-{{ pagerduty_service_name | replace(' ', '_') }} @teams-EmergencyNotifications
          {{ '{{/is_alert}}' }}

          {{ '{{#is_recovery}}' }}
          âœ… UPS returned to AC at {{ inventory_hostname }} (branch {{ branch }}).
          @pagerduty-{{ pagerduty_service_name | replace(' ', '_') }} @teams-EmergencyNotifications
          {{ '{{/is_recovery}}' }}
        thresholds:
          warning:  300   # warn if >5 min on battery
          critical: 600   # critical if >10 min on battery
        priority: 3
        tags:
          - snmp
          - network
          - branch_ups
          - "device_ip:{{ inventory_hostname }}"
          - "branch:{{ branch }}"
          - team:engineering
        notify_no_data: true
        no_data_timeframe: 10
        require_full_window: true
        evaluation_delay: 120
      delegate_to: localhost
